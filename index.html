<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç™¼å¤§è²¡è¨˜å¸³ + å°æ–°äº’å‹•</title>

  <!-- Firebase v9 æ¨¡çµ„åŒ– å¼•å…¥ -->
  <script type="module">
    // å¾ CDN è¼‰å…¥ Firebase v9 ESM æ¨¡çµ„
    import { initializeApp }       from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAnalytics }        from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
    import { getFirestore }        from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ä½ çš„ Firebase configï¼ˆç›´æ¥å¾ Console æ‹·è²è²¼ä¸Šï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyA5eU9ASQCGJweHaAW0pUGDzoNpSZXrcnw",
      authDomain: "fa-da-cai-budgets.firebaseapp.com",
      projectId: "fa-da-cai-budgets",
      storageBucket: "fa-da-cai-budgets.firebasestorage.app",
      messagingSenderId: "775217187438",
      appId: "1:775217187438:web:267bdbda0c6e3deab0b47f",
      measurementId: "G-DZME3R8WF7"
    };

    // åˆå§‹åŒ– Firebase App / Analytics / Firestore
    const app       = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db        = getFirestore(app);

    // æš´éœ²åˆ°å…¨å±€ï¼Œæ–¹ä¾¿å¾ŒçºŒæ”¹å¯« CRUD é‚è¼¯æ™‚ä½¿ç”¨
    window.db = db;
  </script>

  <style>
    * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { margin: 0; padding: 1rem; background: url('bg.jpg') no-repeat center center fixed; background-size: cover; overflow-x: hidden; color: #333; }
    h1 { text-align: center; color: #f44336; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
    .year-switcher { max-width: 900px; margin: 1rem auto; display: flex; align-items: center; gap: 0.5rem; }
    .summary { display: flex; justify-content: center; gap: 1rem; margin: 2rem auto; flex-wrap: wrap; }
    .card { background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 1rem; width: 220px; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
    .big-shadow-num { font-size: 2.3rem; font-weight: bold; text-shadow: 1.5px 1.5px 4px rgba(0,0,0,0.15); letter-spacing: 1px; }
    .form-section { max-width: 900px; margin: 1rem auto; background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 1rem; }
    .form-section h2 { text-align: center; }
    .form-section > div { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .form-section input, .form-section select, .form-section button { flex: 1; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #ccc; }

    /* æ–°å¢ï¼šé€æ˜èƒŒæ™¯çš„ icon æŒ‰éˆ• */
    .icon-btn,
    .delete-btn,
    .expand-btn {
      background: transparent !important;
      border: none !important;
      padding: 0 !important;
      margin: 0 !important;
      cursor: pointer;
    }

    .category-row { display: flex; align-items: center; gap: 0.5em; flex: 1.3; }
    .category-row select { flex: 2; }
    .category-row button { flex: none; }
    .add-category-row { display: flex; gap: 0.3em; align-items: center; margin-top: 0.3em; }
    .add-category-row input { flex: 2; }
    .add-category-row button { flex: none; }
    .card-details-form { width: 100%; background: #fffde7; border-radius: 0.5rem; margin: 0.5em 0; padding: 0.7em 1em; }
    .card-details-form h4 { margin: 0 0 0.5em 0; }
    .card-details-form .detail-row { display: flex; gap: 0.4em; margin-bottom: 0.5em; align-items: center; }
    .card-details-form input[type=text] { flex: 2; }
    .card-details-form input[type=number] { flex: 1.2; }
    .card-details-form button.add-detail-btn { background: #007f0e; color: #fff; border-radius: 0.3em; padding: 0 0.7em; }

    .import-export { max-width: 250px; float: right; margin-top: -7rem; background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .monthly-records { max-width: 900px; margin: 2rem auto; }
    .month-box { background: rgba(230,245,255,0.7); border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 1rem; margin-bottom: 2rem; }
    .month-box:nth-child(even) { background: rgba(230,255,230,0.7); }
    .month-details { display: flex; gap: 1rem; margin-top: 1rem; }
    .month-column { flex: 1; padding: 0.5rem; display: flex; flex-direction: column; justify-content: flex-start; border-right: 1px solid #ccc; }
    .month-column:last-child { border-right: none; }
    .month-column h4 { margin: 0 0 0.25rem 0; }
    .month-column ul, .month-column .exp-list { list-style: none; padding: 0; margin: 0; }
    .month-column li { display: flex; align-items: center; justify-content: space-between; padding: 0.25rem 0; }
    .expense-item-group { display: block; }
    .card-detail-list { margin: 0.5em 0 0.6em 2em; padding-left: 1em; border-left: 2.5px solid #b3cdd1; overflow: hidden; max-height: 0; transition: max-height 0.35s cubic-bezier(0.4,0,0.2,1); }
    .card-detail-list.open { max-height: 600px; transition: max-height 0.45s cubic-bezier(0.4,0,0.2,1); }
    .card-detail-list ul { margin: 0; padding: 0; list-style: none; }
    .card-detail-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.17em 0; }

    .month-totals { display: flex; justify-content: space-between; gap: 1rem; margin-top: 1rem; background: rgba(255,255,255,0.6); padding: 0.75rem; border-radius: 0.75rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-top: 1px solid #ccc; }
    .month-total { flex: 1; text-align: center; font-weight: bold; }
    .red { color: #f44336; } .green { color: #007f0e; }
    #shin-icon { position: fixed; bottom: 20px; right: 20px; width: 200px; animation: float 3s infinite; cursor: pointer; z-index: 1000; }
    #shin-dialog { position: fixed; bottom: 320px; right: 20px; background: rgba(255,249,196,0.95); padding: 0.75rem 1rem; border-radius: 1rem; box-shadow: 0 0 6px rgba(0,0,0,0.2); font-size: 14px; max-width: 200px; z-index: 999; }
    #shin-dialog::after { content: ""; position: absolute; bottom: -12px; right: 20px; border: 10px solid transparent; border-top-color: rgba(255,249,196,0.95); }
    @keyframes float { 0%,100%{transform:translateY(0);}50%{transform:translateY(-10px);} }
  </style>
</head>
<body>
  <h1>ğŸ’° ç™¼å¤§è²¡è¨˜å¸³ç³»çµ± ğŸ’°</h1>
  <div class="year-switcher">
    <label for="year-select">é¸æ“‡å¹´ä»½ï¼š</label>
    <select id="year-select"></select>
  </div>
  <div class="summary">
    <div class="card"><h2>ç¸½æ”¶å…¥</h2><p class="red big-shadow-num" id="total-income">$0</p></div>
    <div class="card"><h2>ç¸½æ”¯å‡º</h2><p class="green big-shadow-num" id="total-expense">$0</p></div>
    <div class="card"><h2>çµé¤˜</h2><p class="red big-shadow-num" id="total-balance">$0</p></div>
  </div>
  <div class="form-section">
    <h2>æ–°å¢æœˆåº¦è¨˜éŒ„</h2>
    <div>
      <input type="month" id="record-month">
      <select id="record-type">
        <option value="income">æ”¶å…¥</option>
        <option value="expense">æ”¯å‡º</option>
      </select>
      <span class="category-row">
        <select id="record-category"></select>
        <button type="button" onclick="showAddCategory()">ï¼‹</button>
        <button type="button" class="icon-btn" onclick="showDeleteCategory()">ğŸ—‘ï¸</button>
      </span>
      <input type="number" id="record-amount" placeholder="é‡‘é¡">
      <button onclick="addRecord()">æ–°å¢</button>
    </div>
    <div id="add-category-row" class="add-category-row" style="display:none;">
      <input type="text" id="new-category-name" placeholder="è¼¸å…¥æ–°åˆ†é¡åç¨±">
      <button type="button" onclick="addCategory()">æ–°å¢</button>
      <button type="button" onclick="hideAddCategory()">å–æ¶ˆ</button>
    </div>
    <div id="delete-category-row" class="add-category-row" style="display:none;">
      <select id="del-category-select"></select>
      <button type="button" onclick="deleteCategory()">åˆªé™¤</button>
      <button type="button" onclick="hideDeleteCategory()">å–æ¶ˆ</button>
    </div>
    <div id="card-details-form" class="card-details-form" style="display:none;">
      <h4>å¡è²»ç´°é …</h4>
      <div id="card-details-rows"></div>
      <button type="button" class="add-detail-btn" onclick="addCardDetailRow()">ï¼‹æ–°å¢ç´°é …</button>
    </div>
  </div>
  <div class="import-export">
    <h3>è³‡æ–™ç®¡ç†</h3>
    <input type="file" accept=".json" onchange="importJSON(event)">
    <button onclick="exportJSON()">åŒ¯å‡º JSON</button>
  </div>
  <div id="month-overview" class="monthly-records">
    <h2 style="text-align:center;">ğŸ“Š æœˆä»½ç¸½è¦½</h2>
    <div id="month-overview-cards" style="display:flex;flex-wrap:wrap;gap:1rem;justify-content:flex-start;"></div>
  </div>
  <div id="monthly-records" class="monthly-records"></div>

  <img id="shin-icon" src="1.png" alt="å°æ–°æµ®å‹•">
  <div id="shin-dialog">å°æ–°æé†’ï¼šä»Šå¤©æœ‰è¨˜å¸³å—ï¼Ÿ</div>

  <script>
    const pics = ['1.png','2.png','3.png','4.png','5.jpg','6.jpg'];
    const messages = [
      "å°æ–°æé†’ï¼šä»Šå¤©æœ‰è¨˜å¸³å—ï¼Ÿ","è¨˜å¾—å®šæœŸè¨˜å¸³ï¼Œç™¼å¤§è²¡å”·ï½ğŸ’°",
      "æ§åˆ¶æ”¯å‡ºï¼Œæ¯å¤©é€²æ­¥ä¸€é»ï¼","ä¿æŒç¿’æ…£ï¼Œå°å¿ƒä¸äº‚èŠ±ï½","è³ºéŒ¢ä¸é›£ï¼Œè¨˜å¸³æ‰é›£ã€‚"
    ];
    let picIndex = 0, msgIndex = 0;
    document.getElementById('shin-icon').onclick = () => {
      picIndex = (picIndex + 1) % pics.length;
      document.getElementById('shin-icon').src = pics[picIndex];
    };
    setInterval(() => {
      msgIndex = (msgIndex + 1) % messages.length;
      document.getElementById('shin-dialog').textContent = messages[msgIndex];
    }, 5000);

    let records = {};
    const saved = localStorage.getItem("budget-records");
    if (saved) try { records = JSON.parse(saved); } catch {}

    let customIncomeCategories = [], customExpenseCategories = [];
    let hiddenIncomeCategories = [], hiddenExpenseCategories = [];

    function getAllCategoriesFromRecords(type) {
      const arr = Object.values(records).flat()
        .filter(r => r.type === type)
        .map(r => r.category);
      const base = arr.concat(type === 'income' ? customIncomeCategories : customExpenseCategories);
      const unique = Array.from(new Set(base));
      const hidden = type === 'income' ? hiddenIncomeCategories : hiddenExpenseCategories;
      return unique.filter(c => !hidden.includes(c));
    }

    function renderCategorySelect() {
      const sel = document.getElementById("record-category");
      const type = document.getElementById("record-type").value;
      sel.innerHTML = getAllCategoriesFromRecords(type)
        .map(c => `<option value="${c}">${c}</option>`).join('');
      checkCardDetailForm();
    }

    function showAddCategory() {
      document.getElementById('add-category-row').style.display = '';
      document.getElementById('delete-category-row').style.display = 'none';
    }
    function hideAddCategory() { document.getElementById('add-category-row').style.display = 'none'; document.getElementById('new-category-name').value = ''; }
    function addCategory() {
      const n = document.getElementById('new-category-name').value.trim();
      const type = document.getElementById('record-type').value;
      if (n) {
        if (type === 'income' && !customIncomeCategories.includes(n)) customIncomeCategories.push(n);
        if (type === 'expense'&& !customExpenseCategories.includes(n)) customExpenseCategories.push(n);
        renderCategorySelect(); document.getElementById('record-category').value = n;
      }
      hideAddCategory(); checkCardDetailForm();
    }

    function showDeleteCategory() {
      document.getElementById('add-category-row').style.display = 'none';
      document.getElementById('delete-category-row').style.display = '';
      const type = document.getElementById('record-type').value;
      document.getElementById('del-category-select').innerHTML =
        getAllCategoriesFromRecords(type)
        .map(c => `<option value="${c}">${c}</option>`).join('');
    }
    function deleteCategory() {
      const type = document.getElementById('record-type').value;
      const c = document.getElementById('del-category-select').value;
      if (!confirm(`ç¢ºå®šè¦å¾é¸å–®ç§»é™¤ã€Œ${c}ã€é€™å€‹åˆ†é¡å—ï¼Ÿ`)) return;
      if (type==='income') {
        hiddenIncomeCategories.push(c);
        customIncomeCategories = customIncomeCategories.filter(v=>v!==c);
      } else {
        hiddenExpenseCategories.push(c);
        customExpenseCategories = customExpenseCategories.filter(v=>v!==c);
      }
      renderCategorySelect(); hideDeleteCategory();
    }
    function hideDeleteCategory(){ document.getElementById('delete-category-row').style.display='none'; }

    function checkCardDetailForm(){
      const type = document.getElementById('record-type').value;
      const cat  = document.getElementById('record-category').value.trim();
      document.getElementById('card-details-form').style.display =
        (type==='expense'&&cat==='å¡è²»')?'':'none';
    }

    function addCardDetailRow(name='',amount=''){
      const ctr = document.getElementById('card-details-rows');
      const row = document.createElement('div');
      row.className='detail-row';
      row.innerHTML=`
        <input type="text" placeholder="åç¨±" value="${name}">
        <input type="number" placeholder="é‡‘é¡" value="${amount}">
        <button class="icon-btn" onclick="this.parentNode.remove()">ğŸ—‘ï¸</button>
      `;
      ctr.appendChild(row);
    }

    document.getElementById('record-type').addEventListener('change',renderCategorySelect);
    document.getElementById('record-category').addEventListener('change',checkCardDetailForm);

    function addRecord(){
      const m = document.getElementById('record-month').value;
      const t = document.getElementById('record-type').value;
      const c = document.getElementById('record-category').value.trim();
      const a = Math.abs(parseFloat(document.getElementById('record-amount').value));
      if(!m||!c||(isNaN(a)&&!(t==='expense'&&c==='å¡è²»'))){
        alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');return;
      }
      if(!records[m]) records[m]=[];
      if(t==='expense'&&c==='å¡è²»'&&document.getElementById('card-details-form').style.display!=='none'){
        const dr = Array.from(document.getElementById('card-details-rows').children);
        let details=[],total=0;
        for(let row of dr){
          const n=row.querySelector('input[type=text]').value.trim();
          const v=Math.abs(parseFloat(row.querySelector('input[type=number]').value));
          if(n&&!isNaN(v)){ details.push({name:n,amount:v}); total+=v; }
        }
        if(!details.length){ alert('è«‹è‡³å°‘è¼¸å…¥ä¸€ç­†å¡è²»ç´°é …'); return; }
        records[m].push({type:t,category:c,amount:total,details});
        document.getElementById('card-details-rows').innerHTML='';
      } else {
        records[m].push({type:t,category:c,amount:a});
      }
      save(); renderYearSelect(); updateUI(); renderCategorySelect(); checkCardDetailForm();
    }

    function save() {
      localStorage.setItem('budget-records', JSON.stringify(records));
    }
    function getAbs(v){ return Math.abs(Number(v)||0); }

    function renderYearSelect(){
      const s=document.getElementById('year-select');
      const yrs=Array.from(new Set(Object.keys(records).map(m=>m.split('-')[0])));
      yrs.sort().reverse();
      s.innerHTML=yrs.map(y=>`<option value="${y}">${y}å¹´</option>`).join('');
      if(!s.value&&yrs.length) s.value=yrs[0];
    }
    document.getElementById('year-select').addEventListener('change',updateUI);

    function updateUI(){
      const prev=document.getElementById('year-select').value;
      renderYearSelect(); document.getElementById('year-select').value=prev;
      const year=prev;
      const overviewCont=document.getElementById('month-overview-cards');
      const cont=document.getElementById('monthly-records');
      overviewCont.innerHTML=''; cont.innerHTML='';

      const monthKeys=Object.keys(records)
        .filter(m=>m.startsWith(year+'-')).sort();
      const all=monthKeys.flatMap(m=>records[m]);
      const totalIncome=all.filter(r=>r.type==='income').reduce((s,r)=>s+getAbs(r.amount),0);
      const totalExpense=all.filter(r=>r.type==='expense').reduce((s,r)=>s+getAbs(r.amount),0);
      const balance=totalIncome-totalExpense;
      document.getElementById('total-income').textContent=`$${totalIncome.toLocaleString()}`;
      document.getElementById('total-expense').textContent=`$${totalExpense.toLocaleString()}`;
      document.getElementById('total-balance').textContent=`$${balance.toLocaleString()}`;
      document.getElementById('total-balance').className = balance>=0? 'red big-shadow-num':'green big-shadow-num';

      let cumulative=0;
      monthKeys.forEach(month=>{
        const entries=records[month];
        const incomes=entries.filter(r=>r.type==='income');
        const expenses=entries.filter(r=>r.type==='expense');
        const sumIncome=incomes.reduce((s,r)=>s+getAbs(r.amount),0);
        const sumExpense=expenses.reduce((s,r)=>s+getAbs(r.amount),0);
        cumulative+=(sumIncome-sumExpense);

        // æœˆåº¦ Overview å¡ç‰‡
        const card=document.createElement('div');
        Object.assign(card.style,{
          background:'rgba(230,245,255,0.7)',
          borderRadius:'1rem',
          boxShadow:'0 2px 6px rgba(0,0,0,0.1)',
          padding:'1rem',
          width:'22%'
        });
        card.innerHTML=`
          <h4 style="text-align:center;">${month}</h4>
          <p>æ”¶å…¥ï¼š<span class="red" style="font-weight:bold;">$${sumIncome.toLocaleString()}</span></p>
          <p>æ”¯å‡ºï¼š<span class="green" style="font-weight:bold;">$${sumExpense.toLocaleString()}</span></p>
          <hr style="margin:0.5rem 0;">
          <div style="margin-top:0.5rem;font-weight:bold;">
            ç´¯ç©çµé¤˜ï¼š<span style="color:${cumulative>=0?'#f44336':'#007f0e'};">$${cumulative.toLocaleString()}</span>
          </div>
        `;
        overviewCont.appendChild(card);

        // æ˜ç´°åˆ—è¡¨
        let html=`
        <div class="month-box">
          <h3>${month}</h3>
          <div class="month-details">
            <div class="month-column">
              <h4>ğŸ’° æ”¶å…¥</h4>
              <ul>`;
        incomes.forEach((r,idx)=>{
          html+=`
                <li>
                  <span>${r.category}</span>
                  <span>
                    <span class="red" style="font-weight:bold;">$${getAbs(r.amount).toLocaleString()}</span>
                    <button class="delete-btn icon-btn" onclick="deleteRecordFromList('${month}','income',${idx})">ğŸ—‘ï¸</button>
                  </span>
                </li>`;
        });
        html+=`      </ul>
            </div>
            <div class="month-column">
              <h4>ğŸ’¸ æ”¯å‡º</h4>
              <ul class="exp-list">`;
        expenses.forEach((r,idx)=>{
          if(r.category==='å¡è²»'&&Array.isArray(r.details)&&r.details.length){
            html+=`
                <li class="expense-item-group">
                  <div style="display:flex;align-items:center;">
                    <span>å¡è²»</span>
                    <button class="expand-btn icon-btn" onclick="toggleDetail(this)">â–¼</button>
                  </div>
                  <div class="card-detail-list">
                    <ul>
                      ${r.details.map((d,didx)=>`
                        <li style="display:flex;align-items:center;">
                          <span>${d.name}</span>
                          <span style="margin:0 0.5em;">
                            <span class="green" style="font-weight:bold;">$${getAbs(d.amount).toLocaleString()}</span>
                            <button class="delete-btn icon-btn"
                                    onclick="deleteCardDetail('${month}',${idx},${didx})">ğŸ—‘ï¸</button>
                          </span>
                        </li>
                      `).join('')}
                    </ul>
                  </div>
                  <div style="display:flex;align-items:center;">
                    <span class="green" style="font-weight:bold;margin-left:auto;">
                      $${getAbs(r.amount).toLocaleString()}&nbsp;
                    </span>
                    <button class="delete-btn icon-btn"
                            onclick="deleteRecordFromList('${month}','expense',${idx})">ğŸ—‘ï¸</button>
                  </div>
                </li>`;
          } else {
            html+=`
                <li>
                  <span>${r.category}</span>
                  <span>
                    <span class="green" style="font-weight:bold;">$${getAbs(r.amount).toLocaleString()}</span>
                    <button class="delete-btn icon-btn" onclick="deleteRecordFromList('${month}','expense',${idx})">ğŸ—‘ï¸</button>
                  </span>
                </li>`;
          }
        });
        html+=`
              </ul>
            </div>
          </div>
          <div class="month-totals">
            <div class="month-total red">æ”¶å…¥ç¸½è¨ˆï¼š$${sumIncome.toLocaleString()}</div>
            <div class="month-total green">æ”¯å‡ºç¸½è¨ˆï¼š$${sumExpense.toLocaleString()}</div>
          </div>
        </div>`;
        cont.insertAdjacentHTML('afterbegin', html);
      });
    }

    window.toggleDetail = btn => {
      const d = btn.closest('.expense-item-group').querySelector('.card-detail-list');
      if (!d) return;
      d.classList.toggle('open');
      btn.textContent = d.classList.contains('open') ? 'â–²' : 'â–¼';
    };

    window.deleteRecordFromList = (month, type, idx) => {
      if (!records[month]) return;
      const arr = records[month].filter(r => r.type === type);
      if (!arr[idx]) return;
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤é€™ä¸€ç­†${type==='income'?'æ”¶å…¥':'æ”¯å‡º'}ï¼Ÿ`)) return;
      let i=-1, c=0;
      for (let j=0;j<records[month].length;j++){
        if(records[month][j].type===type){
          if(c===idx){ i=j; break; }
          c++;
        }
      }
      if(i>=0){
        records[month].splice(i,1);
        if(!records[month].length) delete records[month];
        save(); updateUI(); renderCategorySelect();
      }
    };

    window.deleteCardDetail = (month, expIdx, detailIdx) => {
      if(!records[month]) return;
      let ci=-1,c=0;
      for(let j=0;j<records[month].length;j++){
        if(records[month][j].type==='expense'){
          if(c===expIdx){ ci=j; break; }
          c++;
        }
      }
      if(ci<0) return;
      const card=records[month][ci];
      if(!card.details||!card.details[detailIdx]) return;
      if(!confirm('åˆªé™¤é€™å€‹å¡è²»ç´°é …ï¼Ÿ')) return;
      card.details.splice(detailIdx,1);
      card.amount=card.details.reduce((s,d)=>s+getAbs(d.amount),0);
      save(); updateUI();
    };

    function exportJSON(){
      const data=Object.entries(records).flatMap(([m,a])=>a.map(o=>({month:m,...o})));
      const b=new Blob([JSON.stringify({records:data},null,2)],{type:'application/json'});
      const u=URL.createObjectURL(b);
      const aEl=document.createElement('a');
      aEl.href=u; aEl.download='backup.json'; aEl.click(); URL.revokeObjectURL(u);
    }

    function importJSON(e){
      const f=e.target.files[0];
      if(!f) return;
      const r=new FileReader();
      r.onload=ev=>{
        try{
          const d=JSON.parse(ev.target.result);
          records={};
          d.records.forEach(o=>{
            if(!records[o.month]) records[o.month]=[];
            if(o.details&&Array.isArray(o.details)){
              records[o.month].push({
                type:o.type, category:o.category,
                amount:Math.abs(parseFloat(o.amount)),
                details:o.details.map(d2=>({name:d2.name,amount:Math.abs(parseFloat(d2.amount))}))
              });
            } else {
              records[o.month].push({
                type:o.type, category:o.category,
                amount:Math.abs(parseFloat(o.amount))
              });
            }
          });
          save(); renderYearSelect(); updateUI(); renderCategorySelect(); checkCardDetailForm();
          alert('åŒ¯å…¥æˆåŠŸï¼');
        }catch(err){ alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼'+err); }
      };
      r.readAsText(f);
    }

    // åˆå§‹æ¸²æŸ“
    renderYearSelect();
    updateUI();
    renderCategorySelect();
    checkCardDetailForm();
  </script>
</body>
</html>
