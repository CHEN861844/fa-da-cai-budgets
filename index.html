<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ç™¼å¤§è²¡è¨˜å¸³ + å°æ–°äº’å‹•</title>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ç™¼å¤§è²¡è¨˜å¸³">
  <link rel="apple-touch-icon" href="icon-192.png">

  <!-- Android PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f44336">

  <style>
    /* ---------- åŸå§‹ CSS é–‹å§‹ï¼ˆæ¡Œæ©Ÿèˆ‡æ‰‹æ©Ÿå…±ç”¨ï¼‰ ---------- */
    * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { margin:0; padding:1rem; background:url('bg.jpg') no-repeat center center fixed; background-size:cover; overflow-x:hidden; color:#333; }
    h1 { text-align:center; color:#f44336; text-shadow:1px 1px 2px rgba(0,0,0,0.2); }
    .year-switcher { max-width:900px; margin:1rem auto; display:flex; align-items:center; gap:0.5rem; }
    .summary { display:flex; justify-content:center; gap:1rem; margin:2rem auto; flex-wrap:wrap; }
    .card { background:rgba(255,255,255,0.7); padding:1rem; border-radius:1rem; width:220px; text-align:center; box-shadow:0 4px 8px rgba(0,0,0,0.15); }
    .card:hover { transform:translateY(-4px); box-shadow:0 8px 16px rgba(0,0,0,0.2); }
    .big-shadow-num { font-size:2.3rem; font-weight:bold; text-shadow:1.5px 1.5px 4px rgba(0,0,0,0.15); letter-spacing:1px; }
    .form-section { max-width:900px; margin:1rem auto; background:rgba(255,255,255,0.7); padding:1rem; border-radius:1rem; }
    .form-section h2 { text-align:center; }
    .form-section>div { display:flex; gap:0.5rem; flex-wrap:wrap; }
    .form-section input, .form-section select, .form-section button { flex:1; padding:0.5rem; border-radius:0.5rem; border:1px solid #ccc; }
    .icon-btn, .delete-btn, .expand-btn { background:transparent!important; border:none!important; padding:0; margin:0; cursor:pointer; }
    .category-row { display:flex; align-items:center; gap:0.5em; flex:1.3; }
    .category-row select { flex:2; }
    .category-row button { flex:none; }
    .add-category-row { display:flex; gap:0.3em; align-items:center; margin-top:0.3em; }
    .add-category-row input { flex:2; }
    .add-category-row button { flex:none; }
    .card-details-form { width:100%; background:#fffde7; border-radius:0.5rem; margin:0.5em 0; padding:0.7em 1em; }
    .card-details-form h4 { margin:0 0 0.5em; }
    .card-details-form .detail-row { display:flex; gap:0.4em; margin-bottom:0.5em; align-items:center; }
    .card-details-form input[type=text] { flex:2; }
    .card-details-form input[type=number] { flex:1.2; }
    .card-details-form button.remove-detail-btn { background:transparent!important; border:none!important; cursor:pointer; font-size:1.2rem; }
    .import-export { max-width:250px; float:right; margin-top:-7rem; background:rgba(255,255,255,0.7); padding:1rem; border-radius:1rem; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .monthly-records { max-width:900px; margin:2rem auto; }
    .month-box { background:rgba(230,245,255,0.7); border-radius:1rem; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding:1rem; margin-bottom:2rem; }
    .month-box:nth-child(even) { background:rgba(230,255,230,0.7); }
    .month-details { display:flex; gap:1rem; margin-top:1rem; }
    .month-column { flex:1; padding:0.5rem; display:flex; flex-direction:column; justify-content:flex-start; border-right:1px solid #ccc; }
    .month-column:last-child { border-right:none; }
    .month-column h4 { margin:0 0 0.25rem; }
    .month-column ul, .month-column .exp-list { list-style:none; padding:0; margin:0; }
    .month-column li { display:flex; align-items:center; justify-content:space-between; padding:0.25rem 0; }
    .expense-item-group { display:block; }
    .card-detail-list { margin:0.5em 0 0.6em 2em; padding-left:1em; border-left:2.5px solid #b3cdd1; overflow:hidden; max-height:0; transition:max-height 0.35s cubic-bezier(0.4,0,0.2,1); }
    .card-detail-list.open { max-height:600px; transition:max-height 0.45s cubic-bezier(0.4,0,0.2,1); }
    .card-detail-list ul { margin:0; padding:0; list-style:none; }
    .card-detail-list li { display:flex; justify-content:space-between; align-items:center; padding:0.17em 0; }
    .month-totals { display:flex; justify-content:space-between; gap:1rem; margin-top:1rem; background:rgba(255,255,255,0.6); padding:0.75rem; border-radius:0.75rem; box-shadow:0 2px 6px rgba(0,0,0,0.1); border-top:1px solid #ccc; }
    .month-total { flex:1; text-align:center; font-weight:bold; }
    .red { color:#f44336; } .green { color:#007f0e; }
    #shin-icon { position:fixed; bottom:20px; right:20px; width:200px; animation:float 3s infinite; cursor:pointer; z-index:1000; }
    #shin-dialog { position:fixed; bottom:320px; right:20px; background:rgba(255,249,196,0.95); padding:0.75rem 1rem; border-radius:1rem; box-shadow:0 0 6px rgba(0,0,0,0.2); font-size:14px; max-width:200px; z-index:999; }
    #shin-dialog::after { content:""; position:absolute; bottom:-12px; right:20px; border:10px solid transparent; border-top-color:rgba(255,249,196,0.95); }
    @keyframes float { 0%,100%{transform:translateY(0);}50%{transform:translateY(-10px);} }
    /* ---------- åŸå§‹ CSS çµæŸ ---------- */

    /* å¸³æœ¬åˆ‡æ›æŒ‰éˆ• */
    .owner-tabs { display:flex; justify-content:center; gap:1rem; margin:1rem auto; }
    .owner-tabs button { padding:0.5rem 1rem; border:none; border-radius:1rem; background:rgba(255,255,255,0.7); cursor:pointer; font-weight:bold; transition:background 0.3s; }
    .owner-tabs button.active { background:#f44336; color:#fff; }
    .owner-tabs button:not(.active):hover { background:rgba(244,67,54,0.8); color:#fff; }

    /* é è¨­éš±è— FABï¼Œæ¡Œæ©Ÿä¸æœƒçœ‹åˆ° */
    #fab-add { display:none; }

    /* æ‰‹æ©Ÿå°ˆå±¬ï¼šè¢å¹• â‰¤600px */
    @media (max-width:600px) {
      #shin-icon, #shin-dialog { display: none !important; }
      .import-export { display: none !important; }

      #fab-add {
        display:block; position:fixed; bottom:70px; right:16px;
        width:56px; height:56px; border-radius:50%;
        background:#f44336; color:#fff; font-size:2rem; border:none;
        box-shadow:0 4px 8px rgba(0,0,0,0.2); z-index:1001;
      }
      .month-box .month-details, .month-box .month-totals { display:none; }
      .month-box.open .month-details, .month-box.open .month-totals { display:block; }

      nav.owner-tabs, .year-switcher { position:sticky; top:0; background:rgba(255,255,255,0.9); z-index:500; }

      .summary .card, #month-overview-cards > div { width:90% !important; margin:0.5rem auto; }
      .month-box { width:100% !important; }

      .form-section > div { display:flex !important; flex-direction:column !important; gap:0.5rem; }
      .form-section input, .form-section select, .form-section button { width:100% !important; }

      .owner-tabs { flex-wrap:wrap; gap:0.5rem; }
      .owner-tabs button { flex:1 1 30%; font-size:0.9rem; }
      body { padding:0.5rem; }
    }
  </style>
</head>
<body>
  <h1>ğŸ’° ç™¼å¤§è²¡è¨˜å¸³ç³»çµ± ğŸ’°</h1>
  <nav class="owner-tabs">
    <button data-owner="me" class="active">æˆ‘çš„å¸³æœ¬</button>
    <button data-owner="wife">è€å©†çš„å¸³æœ¬</button>
    <button data-owner="fund">çµå©šåŸºé‡‘</button>
  </nav>

  <div class="year-switcher">
    <label for="year-select">é¸æ“‡å¹´ä»½ï¼š</label>
    <select id="year-select"></select>
  </div>

  <div class="summary">
    <div class="card"><h2>ç¸½æ”¶å…¥</h2><p id="total-income" class="red big-shadow-num">$0</p></div>
    <div class="card"><h2>ç¸½æ”¯å‡º</h2><p id="total-expense" class="green big-shadow-num">$0</p></div>
    <div class="card"><h2>çµé¤˜</h2><p id="total-balance" class="red big-shadow-num">$0</p></div>
  </div>

  <div class="form-section">
    <h2>æ–°å¢æœˆåº¦è¨˜éŒ„</h2>
    <div>
      <input type="month" id="record-month"/>
      <select id="record-type">
        <option value="income">æ”¶å…¥</option>
        <option value="expense">æ”¯å‡º</option>
      </select>
      <span class="category-row">
        <select id="record-category"></select>
        <button type="button" onclick="showAddCategory()">ï¼‹</button>
        <button type="button" class="icon-btn" onclick="showDeleteCategory()">ğŸ—‘ï¸</button>
      </span>
      <input type="number" id="record-amount" placeholder="é‡‘é¡"/>
      <button type="button" onclick="addRecord()">æ–°å¢</button>
    </div>
    <div id="add-category-row" class="add-category-row" style="display:none;">
      <input type="text" id="new-category-name" placeholder="è¼¸å…¥æ–°åˆ†é¡åç¨±"/>
      <button type="button" onclick="addCategory()">æ–°å¢</button>
      <button type="button" onclick="hideAddCategory()">å–æ¶ˆ</button>
    </div>
    <div id="delete-category-row" class="add-category-row" style="display:none;">
      <select id="del-category-select"></select>
      <button type="button" onclick="deleteCategory()">åˆªé™¤</button>
      <button type="button" onclick="hideDeleteCategory()">å–æ¶ˆ</button>
    </div>
    <div id="card-details-form" class="card-details-form" style="display:none;">
      <h4>å¡è²»ç´°é …</h4>
      <div id="card-details-rows"></div>
      <button type="button" class="add-detail-btn" id="add-detail-btn">ï¼‹æ–°å¢ç´°é …</button>
    </div>
  </div>

  <div class="import-export">
    <h3>è³‡æ–™ç®¡ç†</h3>
    <input type="file" accept=".json" onchange="importJSON(event)"/>
    <button type="button" onclick="exportJSON()">åŒ¯å‡º JSON</button>
  </div>

  <div id="month-overview" class="monthly-records">
    <h2 style="text-align:center;">ğŸ“Š æœˆä»½ç¸½è¦½</h2>
    <div id="month-overview-cards" style="display:flex;flex-wrap:wrap;gap:1rem;"></div>
  </div>
  <div id="monthly-records" class="monthly-records"></div>

  <!-- Floating Action Buttonï¼ˆæ¡Œæ©Ÿéš±è—ï¼Œæ‰‹æ©Ÿé¡¯ç¤ºï¼‰ -->
  <button id="fab-add">ï¼‹</button>

  <img id="shin-icon" src="1.png" alt="å°æ–°æµ®å‹•"/>
  <div id="shin-dialog">å°æ–°æé†’ï¼šä»Šå¤©æœ‰è¨˜å¸³å—ï¼Ÿ</div>

  <!-- Firestore æ¨¡çµ„ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
    import {
      getFirestore, collection, getDocs, addDoc, deleteDoc, updateDoc, doc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ä½ çš„ Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyA5eU9ASQCGJweHaAW0pUGDzoNpSZXrcnw",
      authDomain: "fa-da-cai-budgets.firebaseapp.com",
      projectId: "fa-da-cai-budgets",
      storageBucket: "fa-da-cai-budgets.firebasestorage.app",
      messagingSenderId: "775217187438",
      appId: "1:775217187438:web:267bdbda0c6e3deab0b47f",
      measurementId: "G-DZME3R8WF7"
    };

    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const db = getFirestore(app);

    // å…¨åŸŸç‹€æ…‹
    window.records = {};           // { 'YYYY-MM': [ {id, month, type, category, amount, details?, owner} ] }
    window.currentOwner = 'me';    // me | wife | fund

    // ç›®å‰é›†åˆ
    function currentCollection() {
      return collection(db, window.currentOwner + '_records');
    }

    // è¼‰å…¥é›²ç«¯è³‡æ–™
    async function loadRecordsFromCloud() {
      const snap = await getDocs(currentCollection());
      const map = {};
      snap.forEach(s => {
        const o = s.data();
        o._id = s.id;
        if (!map[o.month]) map[o.month] = [];
        map[o.month].push(o);
      });
      window.records = map;
      renderYearSelect(); updateUI(); renderCategorySelect(); checkCardDetailForm();
    }
    document.addEventListener('DOMContentLoaded', loadRecordsFromCloud);

    // æ–°å¢ç´€éŒ„
    async function addRecord() {
      const m = document.getElementById('record-month').value;
      let c = (document.getElementById('record-category').value || '').trim();
      const t = document.getElementById('record-type').value;

      if (!m) { alert('è«‹å¡«å¯«æ—¥æœŸ'); return; }
      if (window.currentOwner === 'fund') c = 'çµå©šåŸºé‡‘';
      if (!c) { alert('è«‹é¸æ“‡åˆ†é¡'); return; }

      let details = [], amount = 0;
      if (t === 'expense' && c === 'å¡è²»') {
        document.querySelectorAll('#card-details-rows .detail-row').forEach(r => {
          const n = r.querySelector('input[type=text]').value.trim();
          const v = Math.abs(parseFloat(r.querySelector('input[type=number]').value)) || 0;
          if (n) { details.push({ name: n, amount: v }); amount += v; }
        });
        if (!details.length) { alert('è«‹è‡³å°‘è¼¸å…¥ä¸€ç­†å¡è²»ç´°é …'); return; }
      } else {
        amount = Math.abs(parseFloat(document.getElementById('record-amount').value)) || 0;
      }

      await addDoc(currentCollection(), { month: m, type: t, category: c, amount, details, owner: window.currentOwner });
      document.getElementById('card-details-rows').innerHTML = '';
      document.getElementById('record-amount').value = '';
      loadRecordsFromCloud();
    }

    // ç²¾æº–åˆªé™¤ï¼ˆç”¨ docIdï¼‰
    async function _delDoc(docId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ')) return;
      await deleteDoc(doc(currentCollection(), docId));
      loadRecordsFromCloud();
    }

    // ç²¾æº–åˆªå¡è²»ç´°é …
    async function _delCardDetail(docId, detailIdx) {
      // æ‰¾ doc
      const month = Object.keys(window.records).find(m => (window.records[m] || []).some(x => x._id === docId));
      if (!month) return;
      const rec = (window.records[month] || []).find(x => x._id === docId);
      if (!rec || !Array.isArray(rec.details)) return;
      if (!confirm('åˆªé™¤é€™å€‹å¡è²»ç´°é …ï¼Ÿ')) return;

      const newDetails = rec.details.slice();
      newDetails.splice(detailIdx, 1);
      const newAmount = newDetails.reduce((s, d) => s + Math.abs(Number(d.amount) || 0), 0);

      await updateDoc(doc(currentCollection(), docId), { details: newDetails, amount: newAmount });
      loadRecordsFromCloud();
    }

    // åŒ¯å…¥ï¼šè¦†è“‹ç›®å‰ owner çš„é›†åˆ
    async function importJSON(e){
      const f=e.target.files[0]; if(!f) return;
      try{
        const txt = await f.text();
        const list = (JSON.parse(txt).records)||[];

        // å…ˆæ¸…ç©ºç•¶å‰é›†åˆ
        const snap = await getDocs(currentCollection());
        for (const d of snap.docs) await deleteDoc(doc(currentCollection(), d.id));

        // å¯«å…¥
        for (const o of list) {
          const payload = {
            month: o.month,
            type: o.type,
            category: o.category,
            amount: Math.abs(parseFloat(o.amount)) || 0,
            owner: window.currentOwner
          };
          if (Array.isArray(o.details)) {
            payload.details = o.details.map(d => ({
              name: String(d.name || ''),
              amount: Math.abs(parseFloat(d.amount)) || 0
            }));
            payload.amount = payload.details.reduce((s, d) => s + (Math.abs(Number(d.amount))||0), 0);
          }
          await addDoc(currentCollection(), payload);
        }

        await loadRecordsFromCloud();
        alert('åŒ¯å…¥æˆåŠŸï¼');
      } catch (err) {
        alert('åŒ¯å…¥å¤±æ•—ï¼š' + err.message);
      }
    }

    // åŒ¯å‡ºï¼šç•¶å‰ owner å…¨éƒ¨è³‡æ–™
    async function exportJSON(){
      const snap = await getDocs(currentCollection());
      const all = snap.docs.map(d => d.data());
      const blob = new Blob([JSON.stringify({records: all}, null, 2)], {type:'application/json'});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url; a.download = `${window.currentOwner}_backup.json`;
      a.click(); URL.revokeObjectURL(url);
    }

    // åˆ‡ ownerï¼šé‡è¼‰é›†åˆ
    document.querySelectorAll('nav.owner-tabs button').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const active = document.querySelector('nav.owner-tabs button.active');
        if (active) active.classList.remove('active');
        btn.classList.add('active');
        window.currentOwner = btn.dataset.owner;
        loadRecordsFromCloud();
      });
    });

    // ç¶å®šåˆ° windowï¼Œçµ¦é module è…³æœ¬/HTML onClick ä½¿ç”¨
    window.addRecord = addRecord;
    window.importJSON = importJSON;
    window.exportJSON = exportJSON;
    window._delDoc = _delDoc;
    window._delCardDetail = _delCardDetail;
  </script>

  <!-- UI / å‘ˆç¾é‚è¼¯ï¼ˆéæ¨¡çµ„ï¼‰ -->
  <script>
    // å°æ–°äº’å‹•
    const pics=['1.png','2.png','3.png','4.png','5.jpg','6.jpg'],
          messages=["å°æ–°æé†’ï¼šä»Šå¤©æœ‰è¨˜å¸³å—ï¼Ÿ","è¨˜å¾—å®šæœŸè¨˜å¸³ï¼Œç™¼å¤§è²¡å”·ï½ğŸ’°","æ§åˆ¶æ”¯å‡ºï¼Œæ¯å¤©é€²æ­¥ä¸€é»ï¼","ä¿æŒç¿’æ…£ï¼Œå°å¿ƒä¸äº‚èŠ±ï½","è³ºéŒ¢ä¸é›£ï¼Œè¨˜å¸³æ‰é›£ã€‚"];
    let picIndex=0,msgIndex=0;
    document.getElementById('shin-icon').onclick=()=>{ picIndex=(picIndex+1)%pics.length; document.getElementById('shin-icon').src=pics[picIndex]; };
    setInterval(()=>{ msgIndex=(msgIndex+1)%messages.length; document.getElementById('shin-dialog').textContent=messages[msgIndex]; },5000);

    // åˆ†é¡ & æ˜ç´°
    let customIncomeCategories=[],customExpenseCategories=[],hiddenIncomeCategories=[],hiddenExpenseCategories=[];

    function getAllCategoriesFromRecords(type){
      const arr=Object.values(window.records).flat().filter(r=>r.type===type).map(r=>r.category);
      const base=arr.concat(type==='income'?customIncomeCategories:customExpenseCategories);
      const hidden=(type==='income'?hiddenIncomeCategories:hiddenExpenseCategories);
      return Array.from(new Set(base)).filter(c=>!hidden.includes(c));
    }

    function renderCategorySelect(){
      const sel=document.getElementById('record-category');
      if(window.currentOwner==='fund'){
        sel.innerHTML=`<option value="çµå©šåŸºé‡‘">çµå©šåŸºé‡‘</option>`;
        document.getElementById('card-details-form').style.display='none'; return;
      }
      const type=document.getElementById('record-type').value;
      sel.innerHTML=getAllCategoriesFromRecords(type).map(c=>`<option value="${c}">${c}</option>`).join('');
      checkCardDetailForm();
    }

    function showAddCategory(){document.getElementById('add-category-row').style.display='';document.getElementById('delete-category-row').style.display='none';}
    function hideAddCategory(){document.getElementById('add-category-row').style.display='none';document.getElementById('new-category-name').value='';}
    function addCategory(){const n=document.getElementById('new-category-name').value.trim(),t=document.getElementById('record-type').value; if(n){if(t==='income'&&!customIncomeCategories.includes(n))customIncomeCategories.push(n);if(t==='expense'&&!customExpenseCategories.includes(n))customExpenseCategories.push(n);renderCategorySelect();document.getElementById('record-category').value=n;}hideAddCategory();checkCardDetailForm();}
    function showDeleteCategory(){document.getElementById('add-category-row').style.display='none';document.getElementById('delete-category-row').style.display='';const t=document.getElementById('record-type').value;document.getElementById('del-category-select').innerHTML=getAllCategoriesFromRecords(t).map(c=>`<option value="${c}">${c}</option>`).join('');}
    function deleteCategory(){const t=document.getElementById('record-type').value,c=document.getElementById('del-category-select').value; if(!confirm(`ç¢ºå®šè¦ç§»é™¤ã€Œ${c}ã€åˆ†é¡ï¼Ÿ`))return; if(t==='income'){hiddenIncomeCategories.push(c);customIncomeCategories=customIncomeCategories.filter(v=>v!==c);}else{hiddenExpenseCategories.push(c);customExpenseCategories=customExpenseCategories.filter(v=>v!==c);}renderCategorySelect();hideDeleteCategory();}
    function hideDeleteCategory(){document.getElementById('delete-category-row').style.display='none';}

    function checkCardDetailForm(){const t=document.getElementById('record-type').value,cat=(document.getElementById('record-category').value||'').trim();document.getElementById('card-details-form').style.display=(t==='expense'&&cat==='å¡è²»')?'':'none';}

    function addCardDetailRow(n='',a=''){const ctr=document.getElementById('card-details-rows'),row=document.createElement('div');row.className='detail-row';row.innerHTML=`<input type="text" placeholder="åç¨±" value="${n}"><input type="number" placeholder="é‡‘é¡" value="${a}"><button type="button" class="remove-detail-btn">ğŸ—‘ï¸</button>`;ctr.appendChild(row);}
    document.getElementById('add-detail-btn').addEventListener('click',()=>addCardDetailRow());
    document.getElementById('card-details-rows').addEventListener('click',e=>{if(e.target.matches('.remove-detail-btn'))e.target.closest('.detail-row').remove();});

    document.getElementById('record-type').addEventListener('change',renderCategorySelect);
    document.getElementById('record-category').addEventListener('change',checkCardDetailForm);

    function renderYearSelect(){const s=document.getElementById('year-select'),yrs=Array.from(new Set(Object.keys(window.records).map(m=>m.split('-')[0])));yrs.sort().reverse();s.innerHTML=yrs.map(y=>`<option value="${y}">${y}å¹´</option>`).join('');if(!s.value&&yrs.length)s.value=yrs[0];}
    document.getElementById('year-select').addEventListener('change',updateUI);

    function getAbs(v){return Math.abs(Number(v)||0);}

    function updateUI(){
      const prev=document.getElementById('year-select').value;renderYearSelect();document.getElementById('year-select').value=prev;const year=prev;
      const overview=document.getElementById('month-overview-cards'),cont=document.getElementById('monthly-records');overview.innerHTML='';cont.innerHTML='';

      const filterFunc = (window.currentOwner==='fund')
        ? (r)=>r.category==='çµå©šåŸºé‡‘'
        : (r)=>r.owner===window.currentOwner;

      const monthKeys=Object.keys(window.records).filter(m=>m.startsWith(year+'-')).sort();
      const all=monthKeys.flatMap(m=>(window.records[m]||[]).filter(filterFunc));
      const ti=all.filter(r=>r.type==='income').reduce((s,r)=>s+getAbs(r.amount),0);
      const te=all.filter(r=>r.type==='expense').reduce((s,r)=>s+getAbs(r.amount),0);
      const bal=ti-te;

      document.getElementById('total-income').textContent=`$${ti.toLocaleString()}`;
      document.getElementById('total-expense').textContent=`$${te.toLocaleString()}`;
      document.getElementById('total-balance').textContent=`$${bal.toLocaleString()}`;
      document.getElementById('total-balance').className=bal>=0?'red big-shadow-num':'green big-shadow-num';

      let cum=0;
      monthKeys.forEach(month=>{
        const es=(window.records[month]||[]).filter(filterFunc);
        const inc=es.filter(r=>r.type==='income'),exp=es.filter(r=>r.type==='expense');
        const si=inc.reduce((s,r)=>s+getAbs(r.amount),0),se=exp.reduce((s,r)=>s+getAbs(r.amount),0);
        cum+=(si-se);

        const card=document.createElement('div');
        Object.assign(card.style,{background:'rgba(230,245,255,0.7)',borderRadius:'1rem',boxShadow:'0 2px 6px rgba(0,0,0,0.1)',padding:'1rem',width:'22%'});
        card.innerHTML=`
          <h4 style="text-align:center;">${month}</h4>
          <p>æ”¶å…¥ï¼š<span class="red" style="font-weight:bold;">$${si.toLocaleString()}</span></p>
          <p>æ”¯å‡ºï¼š<span class="green" style="font-weight:bold;">$${se.toLocaleString()}</span></p>
          <hr style="margin:0.5rem 0;">
          <div style="margin-top:0.5rem;font-weight:bold;">ç´¯ç©çµé¤˜ï¼š<span style="color:${cum>=0?'#f44336':'#007f0e'};">$${cum.toLocaleString()}</span></div>`;
        overview.appendChild(card);

        let html=`<div class="month-box"><h3>${month}</h3><div class="month-details"><div class="month-column"><h4>ğŸ’° æ”¶å…¥</h4><ul>`;
        inc.forEach(r=>{
          html+=`<li><span>${r.category}</span><span><span class="red" style="font-weight:bold;">$${getAbs(r.amount).toLocaleString()}</span> <button class="delete-btn icon-btn" onclick="_delDoc('${r._id}')">ğŸ—‘ï¸</button></span></li>`;
        });
        html+=`</ul></div><div class="month-column"><h4>ğŸ’¸ æ”¯å‡º</h4><ul class="exp-list">`;
        exp.forEach(r=>{
          if(r.category==='å¡è²»' && r.details && r.details.length){
            html+=`<li class="expense-item-group">
              <div style="display:flex;align-items:center;"><span>å¡è²»</span><button class="expand-btn icon-btn" onclick="toggleDetail(this)">â–¼</button></div>
              <div class="card-detail-list"><ul>`;
            r.details.forEach((d,di)=>{
              html+=`<li style="display:flex;align-items:center;">
                <span>${d.name}</span>
                <span style="margin:0 0.5em;"><span class="green" style="font-weight:bold;">$${getAbs(d.amount).toLocaleString()}</span> <button class="delete-btn icon-btn" onclick="_delCardDetail('${r._id}',${di})">ğŸ—‘ï¸</button></span>
              </li>`;
            });
            html+=`</ul></div>
              <div style="display:flex;align-items:center;">
                <span class="green" style="font-weight:bold;margin-left:auto;">$${getAbs(r.amount).toLocaleString()}&nbsp;</span>
                <button class="delete-btn icon-btn" onclick="_delDoc('${r._id}')">ğŸ—‘ï¸</button>
              </div>
            </li>`;
          } else {
            html+=`<li><span>${r.category}</span><span><span class="green" style="font-weight:bold;">$${getAbs(r.amount).toLocaleString()}</span> <button class="delete-btn icon-btn" onclick="_delDoc('${r._id}')">ğŸ—‘ï¸</button></span></li>`;
          }
        });
        html+=`</ul></div></div><div class="month-totals"><div class="month-total red">æ”¶å…¥ç¸½è¨ˆï¼š$${si.toLocaleString()}</div><div class="month-total green">æ”¯å‡ºç¸½è¨ˆï¼š$${se.toLocaleString()}</div></div></div>`;
        cont.insertAdjacentHTML('afterbegin',html);
      });
    }
    window.toggleDetail=btn=>{const d=btn.closest('.expense-item-group').querySelector('.card-detail-list');if(!d)return;d.classList.toggle('open');btn.textContent=d.classList.contains('open')?'â–²':'â–¼';};

    // æ‰‹æ©Ÿ FAB & æ‰‹é¢¨ç´
    if(window.innerWidth<=600){
      document.getElementById('fab-add').addEventListener('click',()=> {
        document.querySelector('.form-section').scrollIntoView({behavior:'smooth'});
      });
      function bindAccordion(){ document.querySelectorAll('.month-box h3').forEach(h=>h.onclick=()=>h.parentNode.classList.toggle('open')); }
      const origUpdate=updateUI;
      updateUI=function(){ origUpdate(); bindAccordion(); };
      bindAccordion();
    }

    // åˆ‡æ› owner åªè² è²¬ UI æ¨£å¼ï¼›è³‡æ–™é‡è¼‰å·²åœ¨ module ç¶å®š
    document.querySelectorAll('nav.owner-tabs button').forEach(btn=>btn.addEventListener('click',()=>{
      const active=document.querySelector('nav.owner-tabs button.active'); if(active) active.classList.remove('active');
      btn.classList.add('active');
    }));
  </script>
</body>
</html>
